# roles/common/tasks/setup_el.yml
---
# Добавление EPEL репозитория
- name: Install EPEL repository 
  ansible.builtin.dnf:
    name: epel-release
    state: present


# установка основных пакетов
- name: Install basic packages 
  ansible.builtin.dnf:
    name:
      - vim
      - nano
      - curl
      - wget
      - htop
      - git
    state: present

# настройка хранения journald логов
- name: Configure journald to persist logs to disk 
  lineinfile:
    path: /etc/systemd/journald.conf
    regexp: "^#?Storage="
    line: "Storage=persistent"
    backup: yes

- name: Create journal directory 
  file:
    path: /var/log/journal
    state: directory
    owner: root
    group: systemd-journal
    mode: '0755'

- name: Add promtail user to systemd-journal group
  user:
    name: promtail
    groups: systemd-journal
    append: yes

- name: Restart systemd-journald to apply changes
  systemd:
    name: systemd-journald
    state: restarted

# Включаем Firewall
- name: Ensure firewalld is started and enabled 
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: yes

# Включаем Selinux в состояние enforcing
- name: Ensure SELinux is enforcing 
  ansible.builtin.selinux:
    policy: targeted
    state: enforcing

- name: Reboot the system if required (e.g., after SELinux change)
  ansible.builtin.reboot:
    msg: "Reboot triggered by Ansible for SELinux"
    connect_timeout: 5
    reboot_timeout: 300
    pre_reboot_delay: 0
    post_reboot_delay: 30
  async: 1
  poll: 0
  ignore_errors: yes